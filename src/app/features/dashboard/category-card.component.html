<button
  class="category-card"
  [attr.data-status]="item().status"
  (click)="toggleDetails()"
  [attr.aria-label]="
    'Category card for ' + item().categoryName + '. Click to toggle details.'
  "
  type="button">
  <div class="card-header">
    <div class="category-info">
      <h3>{{ item().categoryName }}</h3>
      @if (item().categoryGroupName) {
        <p class="group-name">{{ item().categoryGroupName }}</p>
      }
    </div>
    <div class="status-badge-wrapper">
      <app-status-badge [status]="item().status"></app-status-badge>
    </div>
    <button
      class="expand-btn"
      (click)="toggleDetails(); $event.stopPropagation()"
      [attr.aria-label]="showDetails() ? 'Hide details' : 'Show details'">
      @if (showDetails()) {
        <span>▲</span>
      } @else {
        <span>▼</span>
      }
    </button>
  </div>

  @if (hasBudget()) {
    <app-progress-bar
      class="progress-bar-container"
      [spentPercent]="progressValue()"
      [projectedPercent]="upcomingRecurringTotal() > 0 ? projectedValue() : 0"
      [status]="statusColor()"
      [monthProgressPercent]="monthProgressPercent()">
    </app-progress-bar>
  }

  <div class="metrics">
    <div class="metric">
      <span class="label">{{ spentLabelText() }}</span>
      <span class="value">{{ spentLabel() }}</span>
    </div>
    <div class="metric">
      <span class="label">Upcoming</span>
      <span class="value">{{ upcomingLabel() }}</span>
    </div>
    <div class="metric">
      <span class="label">Budget</span>
      <span class="value">{{ budgetLabel() }}</span>
    </div>
    <div
      class="metric remaining-highlight"
      [class.negative]="remainingAfterUpcoming() < 0">
      <span class="label">Remaining</span>
      <span class="value">
        @if (remainingAfterUpcoming() < 0) {
          <span>-{{ remainingAfterUpcomingLabel() }}</span>
        } @else {
          <span>{{ remainingAfterUpcomingLabel() }}</span>
        }
      </span>
    </div>
  </div>

  @if (showDetails()) {
    <section class="details" aria-label="Category details">
      @if (isLoadingTransactions()) {
        <div class="loading">Loading transactions...</div>
      } @else if (transactionsLoadError()) {
        <div class="error-message">
          <p>Unable to load transactions.</p>
          <p class="error-hint">
            @if (isOffline()) {
              <span>You're offline and this data hasn't been cached yet.</span>
            } @else {
              <span>Please check your connection and try again.</span>
            }
          </p>
          @if (!isOffline()) {
            <button
              class="retry-button"
              (click)="retryLoadTransactions(); $event.stopPropagation()"
              type="button">
              Retry
            </button>
          }
        </div>
      } @else if (activityEntries().length === 0) {
        <p class="empty">
          No transactions or upcoming recurring charges recorded for this
          category this month.
        </p>
      } @else {
        <div class="activity-list">
          @for (group of activityGroups(); track group.id) {
            <div class="activity-group">
              <div class="activity-date">{{ group.label }}</div>
              @for (entry of group.entries; track entry.id) {
                <div class="activity-item">
                  <div class="activity-info">
                    <div class="activity-header">
                      <span class="activity-label">{{ entry.label }}</span>
                      @if (shouldShowUpcomingBadge(entry)) {
                        <span class="badge upcoming">{{
                          getUpcomingLabel(entry)
                        }}</span>
                      }
                    </div>
                    @if (entry.notes) {
                      <div class="activity-meta">
                        <span class="notes">{{ entry.notes }}</span>
                      </div>
                    }
                  </div>
                  <div
                    class="activity-amount"
                    [attr.data-color]="getAmountColor(entry)">
                    <div class="amount-primary">{{ formatAmount(entry) }}</div>
                    @if (shouldShowOriginalAmount(entry)) {
                      <div class="amount-secondary">
                        {{ formatOriginalAmount(entry) }}
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </section>
  }
</button>
