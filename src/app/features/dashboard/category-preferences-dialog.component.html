<dialog
  #dialogElement
  class="dialog-container"
  (cancel)="handleClose()"
  aria-labelledby="dialog-title">
  <div class="dialog-content-wrapper">
    <div class="dialog-header">
      <h2 id="dialog-title">Settings</h2>
      <button mat-icon-button (click)="handleClose()" aria-label="Close dialog">
        <mat-icon fontIcon="close"></mat-icon>
      </button>
    </div>

    <div class="dialog-content">
      <!-- Transactions Filter -->
      <div class="setting-section">
        <div class="setting-header">
          <label
            class="toggle-container"
            aria-label="Include pending transactions">
            <input
              type="checkbox"
              [checked]="includeAllTransactions()"
              (change)="handleIncludeAllTransactionsChange($event)" />
            <span class="toggle-slider"></span>
          </label>
          <div class="setting-info">
            <h3>Include pending transactions</h3>
            <p>Show uncleared transactions when viewing category activity.</p>
          </div>
        </div>
      </div>

      <div class="setting-section">
        <div class="setting-header">
          <label class="toggle-container" aria-label="Hide grouped categories">
            <input
              type="checkbox"
              [checked]="hideGroupedCategories()"
              (change)="handleHideGroupedCategoriesChange($event)" />
            <span class="toggle-slider"></span>
          </label>
          <div class="setting-info">
            <h3>Hide grouped categories</h3>
            <p>
              Show parent category groups instead of leaf categories when a
              group exists.
            </p>
          </div>
        </div>
      </div>

      @if (showCustomPeriodSetting()) {
        <div class="setting-section">
          <div class="setting-header">
            <div class="setting-info">
              <h3>Custom budget period</h3>
              <p>
                Change the date range if your budget uses non-monthly periods or
                if you entered the wrong dates.
              </p>
            </div>
            <button
              mat-stroked-button
              type="button"
              class="custom-period-button"
              (click)="handleCustomPeriodRequest()">
              <mat-icon fontIcon="calendar_month"></mat-icon>
              Change period
            </button>
          </div>
        </div>
      }

      <!-- Notifications -->
      <div class="setting-section">
        <div class="setting-header">
          <label class="toggle-container" aria-label="Push notifications">
            <input
              type="checkbox"
              [checked]="notificationsEnabled()"
              (change)="handleNotificationsChange($event)" />
            <span class="toggle-slider"></span>
          </label>
          <div class="setting-info">
            <h3>Push notifications</h3>
            <p>
              Get notified when a category is at risk or goes over budget
              (requires browser permission).
            </p>
          </div>
        </div>
        @if (notificationError(); as notificationError) {
          <div class="notification-error" role="alert">
            <mat-icon fontIcon="warning"></mat-icon>
            <div class="notification-error-content">
              <span class="notification-error-message">{{
                notificationError.message
              }}</span>
              @if (notificationError.links.length > 0) {
                <div class="notification-error-links">
                  @for (link of notificationError.links; track link.url) {
                    <a
                      [href]="link.url"
                      target="_blank"
                      rel="noopener noreferrer"
                      >{{ link.label }}</a
                    >
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Category Settings -->
      <div class="setting-section">
        <button
          type="button"
          class="section-toggle"
          [attr.aria-expanded]="visibleCategoriesExpanded()"
          aria-controls="visible-categories-list"
          (click)="toggleVisibleCategoriesSection()">
          <div class="section-title">
            <h3>Category settings ({{ visibleCategories().length }})</h3>
            <p>Reorder or hide categories to match what you care about most.</p>
          </div>
          <span class="section-chevron" aria-hidden="true">
            {{ visibleCategoriesExpanded() ? '▲' : '▼' }}
          </span>
        </button>
        @if (visibleCategoriesExpanded()) {
          <div id="visible-categories-list" class="category-list">
            @for (
              category of visibleCategories();
              track category.categoryId;
              let i = $index
            ) {
              <div class="category-item">
                <div class="category-info">
                  <div class="category-name">{{ category.categoryName }}</div>
                  @if (category.categoryGroupName) {
                    <div class="category-group">
                      {{ category.categoryGroupName }}
                    </div>
                  }
                </div>
                <div class="category-actions">
                  <button
                    mat-icon-button
                    color="primary"
                    [disabled]="!canMoveUp(i)"
                    (click)="moveCategory(category.categoryId, -1)"
                    matTooltip="Move up"
                    [attr.aria-label]="'Move ' + category.categoryName + ' up'">
                    <mat-icon fontIcon="arrow_upward"></mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="primary"
                    [disabled]="!canMoveDown(i)"
                    (click)="moveCategory(category.categoryId, 1)"
                    matTooltip="Move down"
                    [attr.aria-label]="
                      'Move ' + category.categoryName + ' down'
                    ">
                    <mat-icon fontIcon="arrow_downward"></mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="toggleVisibility(category.categoryId)"
                    matTooltip="Hide category"
                    [attr.aria-label]="'Hide ' + category.categoryName">
                    <mat-icon fontIcon="visibility_off"></mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
          <div class="section-reset-action">
            <button
              mat-stroked-button
              color="primary"
              (click)="resetPreferences()">
              <mat-icon fontIcon="restart_alt"></mat-icon>
              Reset category defaults
            </button>
          </div>
        }
      </div>

      <!-- Hidden Categories -->
      @if (hiddenCategories().length > 0) {
        <div class="setting-section">
          <div class="section-title">
            <h3>Hidden categories ({{ hiddenCategories().length }})</h3>
            <p>Click to show again on your dashboard.</p>
          </div>
          <div class="category-list">
            @for (category of hiddenCategories(); track category.categoryId) {
              <div class="category-item hidden">
                <div class="category-info">
                  <div class="category-name">{{ category.categoryName }}</div>
                  @if (category.categoryGroupName) {
                    <div class="category-group">
                      {{ category.categoryGroupName }}
                    </div>
                  }
                </div>
                <div class="category-actions">
                  <button
                    mat-icon-button
                    (click)="toggleVisibility(category.categoryId)"
                    matTooltip="Show category"
                    [attr.aria-label]="'Show ' + category.categoryName">
                    <mat-icon fontIcon="visibility"></mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Diagnostics Section -->
      <div class="divider"></div>
      <div class="setting-section diagnostics-section">
        <div class="setting-header">
          <label
            class="toggle-container"
            aria-label="Enable diagnostic logging">
            <input
              type="checkbox"
              [checked]="diagnostics.isEnabled()"
              (change)="toggleDiagnostics($event)" />
            <span class="toggle-slider"></span>
          </label>
          <div class="setting-info">
            <h3>Diagnostic logging</h3>
            <p>Help troubleshoot issues by capturing technical app logs.</p>
          </div>
        </div>

        @if (diagnostics.isEnabled() && diagnostics.session(); as session) {
          <div class="diagnostics-controls">
            <div class="support-code-container">
              <span class="support-code-label">Support Code:</span>
              <code class="support-code">{{ session.supportCode }}</code>
              <button
                mat-icon-button
                (click)="copySupportCode()"
                matTooltip="Copy code"
                aria-label="Copy support code">
                <mat-icon fontIcon="content_copy"></mat-icon>
              </button>
            </div>

            <div class="action-buttons">
              <button mat-stroked-button (click)="flushLogs()">
                <mat-icon fontIcon="send"></mat-icon>
                Send logs now
              </button>
              <button
                mat-stroked-button
                color="warn"
                (click)="disableAndDeleteLogs()">
                <mat-icon fontIcon="delete_forever"></mat-icon>
                Disable & delete logs
              </button>
            </div>
          </div>
        }

        <p class="consent-note">
          Diagnostics include technical details about app behavior. By default,
          financial content and secrets are redacted. Use only when requested by
          support.
        </p>
      </div>
    </div>

    <div class="dialog-actions">
      <div class="actions-left">
        <span class="version">Version {{ version }}</span>
        <a
          class="github-link"
          href="https://github.com/astiskala/lunch-buddy"
          target="_blank"
          rel="noopener noreferrer">
          About &amp; support
        </a>
      </div>
      <div class="actions-right">
        <button mat-button type="button" (click)="handleClose()">Cancel</button>
        <button
          mat-flat-button
          color="primary"
          type="button"
          (click)="handleSave()">
          Save
        </button>
      </div>
    </div>
  </div>
</dialog>
