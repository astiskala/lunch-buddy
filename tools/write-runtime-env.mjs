#!/usr/bin/env node
/**
 * @fileoverview Generates a TypeScript module that exports runtime environment
 * values.
 * Values are sourced from process.env at build/serve time and written to
 * src/environments/runtime-env.generated.ts.
 */

import { writeFileSync, mkdirSync } from 'node:fs';
import { dirname, join, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';

const ROOT_DIR = resolve(dirname(fileURLToPath(import.meta.url)), '..');
const OUTPUT_PATH = join(ROOT_DIR, 'src/environments/runtime-env.generated.ts');
const OUTPUT_DIR = dirname(OUTPUT_PATH);

const ENV_PREFIX = 'NG_APP_';

const collectRuntimeEnv = () => {
  const entries = Object.entries(process.env ?? {})
    .filter(([key]) => key.startsWith(ENV_PREFIX))
    .map(([key, value]) => [key, value ?? undefined]);

  return Object.fromEntries(entries);
};

const buildFileContents = values => {
  const entries = Object.entries(values);
  const serialized = entries
    .map(
      ([key, value]) =>
        `  ${key}: ${value === undefined ? 'undefined' : JSON.stringify(value)},`
    )
    .join('\n');
  const objectLiteral = entries.length === 0 ? '{}' : `{\n${serialized}\n}`;

  return `/**
 * @fileoverview Auto-generated runtime environment values.
 * This file is generated by tools/write-runtime-env.mjs.
 * Do not edit this file manually.
 */

export const runtimeEnv: Record<string, string | undefined> = ${objectLiteral};
`;
};

const main = () => {
  const values = collectRuntimeEnv();

  // Ensure the output directory exists as a defensive guard.
  mkdirSync(OUTPUT_DIR, { recursive: true });

  const contents = buildFileContents(values);
  writeFileSync(OUTPUT_PATH, contents, 'utf8');
};

main();
